name: Update Lists (Hagezi & LINE Ads)

on:
  workflow_dispatch: {}    # âœ… å¯æ‰‹å‹•åŸ·è¡Œ
  schedule:
    - cron: '0 1 * * *'    # â° æ¯æ—¥å°ç£æ™‚é–“ 09:00 (UTC 01:00) - é…åˆ Hagezi æ›´æ–°é »ç‡

permissions:
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch and transform
        run: |
          set -euo pipefail
          mkdir -p public

          # =======================================================
          # 1. è™•ç† TIF (Threat Intelligence Feeds)
          # =======================================================
          URL_TIF="https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/wildcard/tif-onlydomains.txt"
          echo "æ­£åœ¨è™•ç† TIF åˆ—è¡¨..."

          curl -fsSL --retry 5 --retry-delay 3 "$URL_TIF" -o /tmp/tif.txt
          sed -E '/^[^#]/ s/^/DOMAIN-SUFFIX,/' /tmp/tif.txt > public/TIF.txt
          sed -i 's/\r$//' public/TIF.txt

          # =======================================================
          # 2. è™•ç† Ultimate
          # =======================================================
          URL_ULTIMATE="https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/wildcard/ultimate-onlydomains.txt"
          echo "æ­£åœ¨è™•ç† Ultimate åˆ—è¡¨..."

          curl -fsSL --retry 5 --retry-delay 3 "$URL_ULTIMATE" -o /tmp/ultimate.txt
          sed -E '/^[^#]/ s/^/DOMAIN-SUFFIX,/' /tmp/ultimate.txt > public/ultimate.txt
          sed -i 's/\r$//' public/ultimate.txt

          # =======================================================
          # 3. è™•ç† LINE Ads Module (ç§»é™¤ system=ios)
          # =======================================================
          URL_LINE="https://raw.githubusercontent.com/jkgtw/Surge/master/Modules/LINE-ADs.sgmodule"
          echo "æ­£åœ¨è™•ç† LINE Ads Module..."

          curl -fsSL --retry 5 --retry-delay 3 "$URL_LINE" -o /tmp/line_ads_raw.sgmodule
          
          # ä½¿ç”¨ sed åˆªé™¤åŒ…å« "#!system=ios" çš„è¡Œï¼Œä¸¦å¯«å…¥ public
          sed '/^#!system=ios/d' /tmp/line_ads_raw.sgmodule > public/LINE-ADs.sgmodule
          sed -i 's/\r$//' public/LINE-ADs.sgmodule

          # =======================================================
          # 4. ç”Ÿæˆé é¢ (index.html)
          # =======================================================
          
          LOCAL_TIME=$(date -d '+8 hour' '+%Y-%m-%d %H:%M:%S UTC+8')
          echo "Generated at ${LOCAL_TIME}"

          # é˜²æ­¢ Jekyll å¿½ç•¥åº•ç·šé–‹é ­æª”æ¡ˆ
          touch public/.nojekyll
          
          # å»ºç«‹ index.html
          cat > public/index.html <<EOF
          <!DOCTYPE html>
          <html lang="zh-Hant">
          <head>
            <meta charset="UTF-8" />
            <title>Custom Rules & Modules (Surge)</title>
            <style>
              body { font-family: "Noto Sans TC", sans-serif; padding: 2rem; line-height: 1.6; background: #f6f8fa; color: #222; }
              h1 { color: #d63384; }
              a { color: #0366d6; text-decoration: none; font-weight: bold; font-size: 1.1rem;}
              a:hover { text-decoration: underline; }
              .box { background: #fff; border: 1px solid #ddd; padding: 1.5rem; margin-bottom: 1rem; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);}
              ul { list-style-type: none; padding: 0; }
              li { margin-bottom: 10px; }
              .tag { display: inline-block; padding: 2px 6px; font-size: 0.8rem; border-radius: 4px; color: #fff; margin-left: 8px; vertical-align: middle;}
              .tag-tif { background-color: #d9534f; }
              .tag-ult { background-color: #f0ad4e; }
              .tag-mod { background-color: #00c300; } /* LINE Green */
            </style>
          </head>
          <body>
            <h1>ğŸ›¡ï¸ Custom Lists for Surge</h1>
            <p>æœ¬é è‡ªå‹•ç”Ÿæˆæ–¼ï¼š${LOCAL_TIME}</p>
            
            <div class="box">
              <h3>ğŸ“¥ è¦å‰‡æ¸…å–® (Rule Sets)</h3>
              <p>ä»¥ä¸‹æª”æ¡ˆçš†å·²è½‰æ›ç‚º <code>DOMAIN-SUFFIX</code> æ ¼å¼ã€‚</p>
              <ul>
                <li>
                  <a href="TIF.txt" download>â¬‡ï¸ ä¸‹è¼‰ TIF.txt</a>
                  <span class="tag tag-tif">é«˜å¨è„…é˜²è­·</span>
                  <br><small style="color:#666;">Threat Intelligence Feeds (æƒ¡æ„è»Ÿé«”ã€é‡£é­šã€æ®­å±ç¶²è·¯)</small>
                </li>
                <li style="margin-top: 15px;">
                  <a href="ultimate.txt" download>â¬‡ï¸ ä¸‹è¼‰ ultimate.txt</a>
                  <span class="tag tag-ult">æœ€å¼·åŠ›å»£å‘Šé˜»æ“‹</span>
                  <br><small style="color:#666;">Hagezi Ultimate (åŒ…å« Pro++ èˆ‡æ›´å¤šéæ¿¾è¦å‰‡)</small>
                </li>
              </ul>
            </div>

            <div class="box">
              <h3>ğŸ§© æ¨¡çµ„ (Modules)</h3>
              <ul>
                <li>
                  <a href="LINE-ADs.sgmodule" download>â¬‡ï¸ ä¸‹è¼‰ LINE-ADs.sgmodule</a>
                  <span class="tag tag-mod">LINE å»å»£å‘Š</span>
                  <br><small style="color:#666;">Source: jkgtw (å·²è‡ªå‹•ç§»é™¤ system=ios é™åˆ¶)</small>
                </li>
              </ul>
            </div>

            <hr>
            <p><small>Sources: <a href="https://github.com/hagezi/dns-blocklists" target="_blank">hagezi/dns-blocklists</a>, <a href="https://github.com/jkgtw/Surge" target="_blank">jkgtw/Surge</a></small></p>
          </body>
          </html>
          EOF

          # è¨­å®š CNAME
          echo "github.yuying45.win" > public/CNAME

      - name: Upload artifact for GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./public

  deploy:
    needs: update
    runs-on: ubuntu-latest
    environment:
      name: github-pages
    steps:
      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
